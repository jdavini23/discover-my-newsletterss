name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Dependencies
      run: npm ci
    
    # Dependency Vulnerability Scan
    - name: NPM Audit
      run: npm audit --audit-level=high
      continue-on-error: true
    
    # Static Code Analysis
    - name: ESLint Security Scan
      run: npx eslint . --ext .ts --format json --output-file eslint-report.json
      continue-on-error: true
    
    # Dependency Scanning
    - name: Snyk Vulnerability Scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        command: test
    
    # Secret Scanning
    - name: Detect Secrets
      uses: reviewdog/action-detect-secrets@v0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
    
    # OWASP Dependency Check
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'Newsletter Discovery Platform'
        path: '.'
        format: 'HTML'
    
    # Upload Security Reports
    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          eslint-report.json
          dependency-check-report.html
    
    # Notification on Critical Vulnerabilities
    - name: Slack Notification
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Security scan detected critical vulnerabilities!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # Optional Performance and Load Testing
  performance-test:
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Performance Testing
      run: npm run load:test
      continue-on-error: true
